# –í–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
API_TOKEN = '8292585151:AAGXg5aM_UXR8czFuIjoRgIkkbrnERKDPbs'
bot = telebot.TeleBot(API_TOKEN)

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
conn = sqlite3.connect('real_estate.db', check_same_thread=False)
cursor = conn.cursor()

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data = {}


# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def start(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn1 = types.KeyboardButton('–ñ–ö ‚Ññ1 –°–µ–º–µ–π–Ω–∞—è –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç 5,9%')
    btn2 = types.KeyboardButton('–ñ–ö ‚Ññ2 –°–µ–º–µ–π–Ω–∞—è –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç 3,5%')
    markup.add(btn1, btn2)

    bot.send_message(message.chat.id, '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç:', reply_markup=markup)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–±—ä–µ–∫—Ç–∞
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    user_id = message.from_user.id

    if message.text in ['–ñ–ö ‚Ññ1 –°–µ–º–µ–π–Ω–∞—è –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç 5,9%', '–ñ–ö ‚Ññ2 –°–µ–º–µ–π–Ω–∞—è –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç 3,5%']:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞
        object_name = message.text
        object_id = 1 if object_name == '–ñ–ö ‚Ññ1 –°–µ–º–µ–π–Ω–∞—è –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç 5,9%' else 2
        user_data[user_id] = {'object_id': object_id, 'object_name': object_name}

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        contact_btn = types.KeyboardButton('üìû –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∞–≥–µ–Ω—Ç–∞')
        markup.add(contact_btn)

        bot.send_message(message.chat.id,
                         f'–í—ã –≤—ã–±—Ä–∞–ª–∏: {object_name}.\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–≤—è–∑–∏ —Å –∞–≥–µ–Ω—Ç–æ–º.',
                         reply_markup=markup)

    elif message.text == 'üìû –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∞–≥–µ–Ω—Ç–∞':
        if user_id in user_data:
            object_id = user_data[user_id]['object_id']
            object_name = user_data[user_id]['object_name']

            print(f"üîç –ò—â–µ–º –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ {object_name} (ID: {object_id})")

            # –®–ê–ì 1: –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –≠–¢–û–ì–û –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –æ–±—ä–µ–∫—Ç–∞
            cursor.execute('''
                SELECT id, username, queue_order 
                FROM agents 
                WHERE object_id = ? 
                ORDER BY queue_order 
                LIMIT 1
            ''', (object_id,))

            agent = cursor.fetchone()

            if agent:
                agent_id, agent_username, current_order = agent
                print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∞–≥–µ–Ω—Ç: {agent_username} (–ø–æ—Ä—è–¥–æ–∫: {current_order}) –¥–ª—è {object_name}")

                # –û—Ç–¥–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                bot.send_message(message.chat.id,
                                 f'üè¢ {object_name}\nü§ù –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–≥–µ–Ω—Ç–æ–º: @{agent_username}\n\n–û–Ω –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å –≤—ã–±–æ—Ä–æ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã!',
                                 reply_markup=types.ReplyKeyboardRemove())

                # –®–ê–ì 2: –ù–∞—Ö–æ–¥–∏–º –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤ –æ—á–µ—Ä–µ–¥–∏ –î–õ–Ø –≠–¢–û–ì–û –û–ë–™–ï–ö–¢–ê
                cursor.execute('SELECT MAX(queue_order) FROM agents WHERE object_id = ?', (object_id,))
                max_order_result = cursor.fetchone()
                max_order = max_order_result[0] if max_order_result[0] else 0

                print(f"üìä –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è {object_name}: {max_order}")

                # –®–ê–ì 3: –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∞–≥–µ–Ω—Ç–∞ –≤ –ö–û–ù–ï–¶ –æ—á–µ—Ä–µ–¥–∏ –≠–¢–û–ì–û –û–ë–™–ï–ö–¢–ê
                new_order = max_order + 1
                cursor.execute('UPDATE agents SET queue_order = ? WHERE id = ?', (new_order, agent_id))
                conn.commit()

                print(f"üîÑ –ê–≥–µ–Ω—Ç {agent_username} –ø–µ—Ä–µ–º–µ—â–µ–Ω —Å {current_order} –Ω–∞ {new_order} –≤ {object_name}")

                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                cursor.execute('''
                    SELECT username, queue_order 
                    FROM agents 
                    WHERE object_id = ? 
                    ORDER BY queue_order
                ''', (object_id,))

                agents_list = cursor.fetchall()
                queue_info = f"–û—á–µ—Ä–µ–¥—å {object_name}:\n" + "\n".join(
                    [f"{i + 1}. @{agent[0]}" for i, agent in enumerate(agents_list)])
                print(queue_info)

            else:
                bot.send_message(message.chat.id,
                                 f'üòî –î–ª—è –æ–±—ä–µ–∫—Ç–∞ {object_name} –ø–æ–∫–∞ –Ω–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤.\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.',
                                 reply_markup=types.ReplyKeyboardRemove())

            # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            del user_data[user_id]
        else:
            bot.send_message(message.chat.id, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç.')


print("üü¢ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ –æ—á–µ—Ä–µ–¥—è–º–∏...")
bot.polling()